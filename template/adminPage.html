<!DOCTYPE html>
<html>
    <head>
        <title>Admin Page</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='Styles/adminPage_style.css') }}">
    </head>
    <body>
        <!-- same content as dashboard.html but with admin functionalities -->
        <div class="container">
            <div class="header-section">
                <h1>Admin Dashboard</h1>
            </div>
            <div class="container-row">

            <!-- Booking form with User ID and Password-->
             <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Set Threshold Manually</h3>
                        <button type="button" class="btn-close" aria-label="Close" onclick="toggleThresholdCard()"></button>
                    </div>
                    <div class="threshold-section card-body" id="thresholdCardBody">
                        <div class="form-group d-flex align-items-center mb-3">
                            <span class="me-2"><i class="bi bi-thermometer-half"></i></span>
                            <label for="temperatureThreshold" class="me-2 mb-0">Temperature:</label>
                            <input type="number" id="lowTemperatureThreshold" name="lowTemperatureThreshold" class="form-control w-auto" value="22" min="15" max="22">
                            <input type="number" id="highTemperatureThreshold" name="highTemperatureThreshold" class="form-control w-auto" value="25" min="22" max="28">
                        </div>
                        <div class="form-group d-flex align-items-center mb-3">
                            <span class="me-2"><i class="bi bi-droplet-half"></i></span>
                            <label for="humidityThreshold" class="me-2 mb-0">Humidity:</label>
                            <input type="number" id="humidityThreshold" name="humidityThreshold" class="form-control w-auto" value="50" min="30" max="70">
                        </div>
                        <div class="form-group d-flex align-items-center mb-3">
                            <div class="toggle-switch d-flex align-items-center">
                                <label for="lightSwitch" class="me-2 mb-0">Switch Light in Study Room:</label>
                                <div class="switch-icon" id="lightSwitchIcon">ðŸ’¡</div>
                                <label class="switch">
                                    <input type="checkbox" id="lightSwitch" name="lightSwitch" onclick="toggleLightControl()">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="saveThresholdsButton">Save Thresholds</button>
                    </div>
             <div class="user-authentication">
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" name="userId" placeholder="Enter your User ID" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" placeholder="Enter your Password" required>
                </div>
             </div>


            <!-- Time Selection Form -->
            <div class="time-selection-section">
                <h3>Select Time Slot</h3>
                <div class="time-form">
                    <div class="form-group">
                        <label for="bookingDate">Date:</label>
                        <input type="date" id="bookingDate" name="bookingDate" required>
                    </div>
                    <!-- time slots in 5 minute intervals -->

                    <div class="form-group">
                        <label for="startTime">Start Time:</label>
                        <select id="startTime" name="startTime" required>
                            <option value=""></option>
                            {% for slot in time_slots %}
                                <option value="{{ slot }}">{{ slot }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="endTime">End Time:</label>
                        <select id="endTime" name="endTime" required>
                            <option value=""></option>
                            {% for slot in time_slots %}
                                <option value="{{ slot }}">{{ slot }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- Seating Plan -->
            <div class="card">
            <div class="seating-section">
                <h3>Select Your Seat</h3>
                <div class="seat-legend">
                    <div class="legend-item">
                        <div class="seat-indicator free"></div>
                        <span>Available:</span>
                        <!-- show number of seats available -->
                        <span id="availableSeatsCount">{{ availableSeatsCount }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat-indicator occupied"></div>
                        <span>Occupied:</span>
                        <span id="occupiedSeatsCount">{{ occupiedSeatsCount }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat-indicator selected"></div>
                        <!-- Show selected seat number -->
                         <!-- if selectedSeatNumber is set -->
                         {%if selectedSeatNumber %}
                        <span id="selectedSeatNumber">{{ selectedSeatNumber }}</span>
                         {%else %}
                        <span id="selectedSeatNumber">None</span>
                            {%endif %}
                    </div>
                </div>
                <!-- Room Selection -->
            <div class="room-selection">
                <label for="rooms">Select Room:</label>
                <select name="room" id="rooms" onchange="loadSeatsForRoom()">
                    <option value="">-- Select Study Room --</option>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- booking information on selected seat -->
             <div class="booking-info">
                <div class="form-group">
                    <label for="bookingInfo">Booking Information:</label>
                    <div class="booking-info-textarea">
                        <textarea id="bookingInfo" name="bookingInfo" rows="4" placeholder="Booking information will be displayed here..." readonly></textarea>
                    </div>
                </div>
             </div>
            </div>
            <div class="seat-container" id="seatsContainer">
                <div class="seating-grid" id="seatsGrid">
                    <!-- Seats will be loaded here dynamically -->
                </div>
            </div>
            
            <!-- Booking Button -->
            <div class="booking-actions">
                <button id="bookButton" onclick="bookSelectedSeat()" disabled>Book Selected Seat</button>
                <button onclick="window.close()">Cancel</button>
            </div>
            </div>
            </div>
        </div>
<!-- Hidden data for JavaScript -->
        <script type="application/json" id="roomsData">{{ rooms | tojson }}</script>
        <script type="application/json" id="seatsData">{{ seats | tojson }}</script>
        <script type="application/json" id="timeSlotsData">{{ time_slots | tojson }}</script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
        <script>
            const mqttBrokerUrl = 'ws://192.168.188.40:9001';
            const mqttOptions = {
                clientId: 'dashboard_' + Math.random().toString(16).substr(2, 8),
                clean: true,
                connectTimeout: 4000,
                reconnectPeriod: 4000,
            };

            let mqttClient = null;

            function connectMQTT() {
                mqttClient = mqtt.connect(mqttBrokerUrl, mqttOptions);

                mqttClient.on('connect', function () {
                    console.log('Connected to MQTT broker');
                    mqttClient.subscribe('library/SR_1/Sensor/#', function (err) {
                        if (!err) {
                            console.log('Subscribed to library/SR_1/Sensor');
                            //publish threshold values
                            // const lowTemperatureThreshold = document.getElementById('lowTemperatureThreshold').value;
                            // const highTemperatureThreshold = document.getElementById('highTemperatureThreshold').value;
                            document.getElementById('saveThresholdsButton').addEventListener('click', function() {
                                const lowTemperatureThreshold = document.getElementById('lowTemperatureThreshold').value;
                                const highTemperatureThreshold = document.getElementById('highTemperatureThreshold').value;
                                const humidityThreshold = document.getElementById('humidityThreshold').value;
                                const lightThreshold = document.getElementById('lightThreshold').value;
                                // Publish threshold values to MQTT topics
                                console.log('Publishing thresholds:', {
                                    lowTemperatureThreshold,
                                    highTemperatureThreshold,
                                    humidityThreshold,
                                    lightThreshold
                                });
                                mqttClient.publish('library/SR_1/Sensor_Threshold/Threshold_Temperature_Low',
                                    `{'Device': 'Temperature_Threshold_Low', 'Value': '${lowTemperatureThreshold}'}`,
                                    { qos: 1, retain: true });
                                mqttClient.publish('library/SR_1/Sensor_Threshold/Threshold_Temperature_High',
                                    `{'Device': 'Temperature_Threshold_High', 'Value': '${highTemperatureThreshold}'}`,
                                    { qos: 1, retain: true });
                                mqttClient.publish('library/SR_1/Sensor_Threshold/Threshold_Humidity',
                                    `{'Device': 'Humidity_Threshold', 'Value': '${humidityThreshold}'}`,
                                    { qos: 1, retain: true });
                                // mqttClient.publish('library/SR_1/Sensor_Threshold/Threshold_Light',
                                //     `{'Device': 'Light_Threshold', 'Value': '${lightThreshold}'}`,
                                //     { qos: 1, retain: true });
                            });

                        } else if (err.message === 'Invalid topic') {
                            console.error('Invalid topic for subscription:', err);
                        } else {
                            console.error('Subscription error:', err);
                        }
                    });
                    
                });
            }
            connectMQTT();
        </script>
    </body>
</html>

<script>
    let selectedSeat = null;
    let roomsData = [];
    let seatsData = [];
    let timeSlotsData = [];

    // Load data from hidden script tags
    try {
        roomsData = JSON.parse(document.getElementById('roomsData').textContent);
        seatsData = JSON.parse(document.getElementById('seatsData').textContent);
        timeSlotsData = JSON.parse(document.getElementById('timeSlotsData').textContent);
    } catch (e) {
        console.error('Error loading room/seat data:', e);
        roomsData = [];
        seatsData = [];
        timeSlotsData = [];
    }

    function toggleLightControl() {
        const lightSwitch = document.getElementById('lightSwitch');
        const lightSwitchIcon = document.getElementById('lightSwitchIcon');
        if (lightSwitch.checked)
            lightSwitchIcon.textContent = 'ðŸ’¡'; // Light on icon
        else
            lightSwitchIcon.textContent = 'ðŸŒ‘'; // Light off icon
        mqttClient.publish('library/SR_1/Plugwise/Light', `${lightSwitch.checked ? 'on' : 'off'}`, { qos: 1, retain: true });
    }

    function loadSeatsForRoom() {
        const roomSelect = document.getElementById('rooms');
        const selectedRoomId = roomSelect.value;
        const seatsGrid = document.getElementById('seatsGrid');
        const bookButton = document.getElementById('bookButton');
        
        // Clear previous seats
        seatsGrid.innerHTML = '';
        selectedSeat = null;
        bookButton.disabled = true;
        
        if (!selectedRoomId) return;
        
        // Filter seats for selected room
        const roomSeats = seatsData.filter(seat => {
            // Handle both tuple format (database result) and object format
            const seatRoomId = seat[1] || seat.room_id; // Assuming room_id is at index 1
            return seatRoomId == selectedRoomId;
        });
        
        // Create seat buttons
        roomSeats.forEach((seat, index) => {
            const seatId = seat[0] || seat.id;
            const seatName = seat[2] || seat.name || `Seat ${index + 1}`;
            const isOccupied = seat[3] || seat.occupied || false;
            
            const seatButton = document.createElement('button');
            seatButton.className = `seat ${isOccupied ? 'occupied' : 'free'}`;
            seatButton.textContent = seatName;
            seatButton.disabled = isOccupied;
            seatButton.onclick = () => selectSeat(seatId, seatName, selectedRoomId);
            
            seatsGrid.appendChild(seatButton);
        });
        
        // If no seats found, create default grid
        if (roomSeats.length === 0) {
            for (let i = 1; i <= 20; i++) {
                const seatButton = document.createElement('button');
                seatButton.className = 'seat free';
                seatButton.textContent = `Seat ${i}`;
                seatButton.onclick = () => selectSeat(i, `Seat ${i}`, selectedRoomId);
                seatsGrid.appendChild(seatButton);
            }
        }
    }

    function selectSeat(seatId, seatName, roomId) {
        // Remove previous selection
        document.querySelectorAll('.seat.selected').forEach(seat => {
            seat.classList.remove('selected');
        });
        
        // Select new seat
        event.target.classList.add('selected');
        selectedSeat = {
            id: seatId,
            name: seatName,
            roomId: roomId
        };
        
        // Enable book button
        document.getElementById('bookButton').disabled = false;
        
        console.log(`Selected seat: ${seatName} in room ${roomId}`);
    }

    function bookSelectedSeat() {
        if (!selectedSeat) {
            alert('Bitte wÃ¤hlen Sie einen Platz aus.');
            return;
        }
        
        // Save selected occupied seat and Id
        localStorage.setItem('selectedSeat', JSON.stringify(selectedSeat));
        alert('Seat {selectedSeat.name} booked succesfully!');
    }
        // Add time validation
    function validateTimeSelection() {
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        
        if (startTime && endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            
            if (endMinutes <= startMinutes) {
                alert('End time must be after start time');
                document.getElementById('endTime').value = '';
                return false;
            }
        }
        return true;
    }

    function timeToMinutes(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
    }

    // Add event listeners for time validation
    document.addEventListener('DOMContentLoaded', () => {
        const startTimeSelect = document.getElementById('startTime');
        const endTimeSelect = document.getElementById('endTime');
        
        startTimeSelect.addEventListener('change', validateTimeSelection);
        endTimeSelect.addEventListener('change', validateTimeSelection);
    });

    function displayBookingInfo() {
        const bookingInfo = document.getElementById('bookingInfo');
        const bookingDate = document.getElementById('bookingDate').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const roomSelect = document.getElementById('rooms');
        const selectedRoomName = roomSelect.options[roomSelect.selectedIndex].text;
        
        if (bookingDate && startTime && endTime && selectedSeat) {
            bookingInfo.value = `Room: ${selectedRoomName}\nSeat: ${selectedSeat.name}\nDate: ${bookingDate}\nStart Time: ${startTime}\nEnd Time: ${endTime}`;
        } else {
            bookingInfo.value = 'Please fill in all fields.';
        }
    }


    function toggleThresholdCard() {
        const cardBody = document.getElementById('thresholdCardBody');
        cardBody.style.display = cardBody.style.display === 'none' ? 'block' : 'none';
    }
    function saveThresholds() {
        const temp = document.getElementById('temperatureThreshold').value;
        const humidity = document.getElementById('humidityThreshold').value;
        const light = document.getElementById('lightThreshold').value;
        // publish thresholds to server with mqtt
        // mqttClient.publish('library/SR_1/Sensor/Threshold_Temperature',
        //     `{'Device': 'Temperature_Sensor_Low', 'Threshold_Value': '${lowTemperatureThreshold}'}`,
        //     { qos: 1, retain: true });
        // mqttClient.publish('library/SR_1/Sensor/Threshold_Temperature',
        //     `{'Device': 'Temperature_Sensor_High', 'Threshold_Value': '${highTemperatureThreshold}'}`,
        //     { qos: 1, retain: true });
        // mqttClient.publish('library/SR_1/Sensor/Threshold_Humidity',
        //     `{'Device': 'Humidity_Sensor', 'Threshold_Value': '${humidityThreshold}'}`,
        //     { qos: 1, retain: true });
        // mqttClient.publish('library/SR_1/Sensor/Threshold_Light',
        //     `{'Device': 'Light_Sensor', 'Threshold_Value': '${lightThreshold}'}`,
        //     { qos: 1, retain: true });
        //alert(`Thresholds saved:\nTemperature: ${temp}\nHumidity: ${humidity}\nLight: ${light}`);
    }

    

    // LogIn with rsa to encode and decode
    // function secureLogin() {
    //     //generate rsa keys
    //     const { publicKey, privateKey } = rsa.generateKeyPair(1024);
    //     const username = document.getElementById('username').value;
    //     const password = document.getElementById('password').value;
    //     if (!username || !password) {
    //         alert('Please enter both username and password');
    //         return;
    //     }
    //     // Encrypt username and password
    //     const encryptedUsername = rsa.encrypt(username, publicKey);
    //     const encryptedPassword = rsa.encrypt(password, publicKey);
    //     // Send encrypted data to server
    //     fetch('/login', {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json'
    //         },
    //         body: JSON.stringify({
    //             username: encryptedUsername,
    //             password: encryptedPassword
    //         })
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.success) {
    //             alert('Login successful!');
    //             // Redirect to dashboard or perform other actions
    //             window.location.href = '/dashboard';
    //         } else {
    //             alert('Login failed: ' + data.message);
    //         }
    //     })
    //     .catch(error => {
    //         console.error('Error during login:', error);
    //         alert('An error occurred during login. Please try again.');
    //     });
    // }

</script>