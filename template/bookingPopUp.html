<!DOCTYPE html>
<html>
    <head>
        <title>Platzbuchung</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="{{ url_for('static', filename='Styles/BookingSystem_style.css') }}">
    </head>
    <body>
        <div class="booking-container">
            <h2>Book Your Seat</h2>
            <!-- Booking form with User ID and Password-->
             <div class="user-authentication">
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" name="userId" placeholder="Enter your User ID" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" placeholder="Enter your Password" required>
                </div>
             </div>


            <!-- Time Selection Form -->
            <div class="time-selection-section">
                <h3>Select Time Slot</h3>
                <div class="time-form">
                    <div class="form-group">
                        <label for="bookingDate">Date:</label>
                        <input type="date" id="bookingDate" name="bookingDate" required>
                    </div>
                    <!-- time slots in 5 minute intervals -->

                    <div class="form-group">
                        <label for="startTime">Start Time:</label>
                        <select id="startTime" name="startTime" required>
                            <option value=""></option>
                            {% for slot in time_slots %}
                                <option value="{{ slot }}">{{ slot }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="endTime">End Time:</label>
                        <select id="endTime" name="endTime" required>
                            <option value=""></option>
                            {% for slot in time_slots %}
                                <option value="{{ slot }}">{{ slot }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Room Selection -->
            <div class="room-selection">
                <label for="rooms">Select Room:</label>
                <select name="room" id="rooms" onchange="loadSeatsForRoom()">
                    <option value="">-- Select Study Room --</option>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Seating Plan -->
            <div class="seating-section">
                <h3>Select Your Seat</h3>
                <div class="seat-legend">
                    <div class="legend-item">
                        <div class="seat-indicator free"></div>
                        <span>Available:</span>
                        <!-- show number of seats available -->
                        <span id="availableSeatsCount">{{ availableSeatsCount }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat-indicator occupied"></div>
                        <span>Occupied:</span>
                        <span id="occupiedSeatsCount">{{ occupiedSeatsCount }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat-indicator selected"></div>
                        <!-- Show selected seat number -->
                         <!-- if selectedSeatNumber is set -->
                         {%if selectedSeatNumber %}
                        <span id="selectedSeatNumber">{{ selectedSeatNumber }}</span>
                         {%else %}
                        <span id="selectedSeatNumber">{% if selectedSeatNumber is not none %}{{ selectedSeatNumber }}{% else %}None{% endif %}</span>
                            {%endif %}
                    </div>
                </div>
                
                <div class="container" id="seatsContainer">
                    <div class="seating-grid" id="seatsGrid">
                        <!-- Seats will be loaded here dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Booking Button -->
            <div class="booking-actions">
                <button id="bookButton" onclick="bookSelectedSeat()" disabled>Book Selected Seat</button>
                <button onclick="window.close()">Cancel</button>
            </div>
        </div>

        <!-- Hidden data for JavaScript -->
        <script type="application/json" id="roomsData">{{ rooms | tojson }}</script>
        <script type="application/json" id="seatsData">{{ seats | tojson }}</script>
        <script type="application/json" id="timeSlotsData">{{ time_slots | tojson }}</script>
    </body>
</html>

<script>
    let selectedSeat = null;
    let roomsData = [];
    let seatsData = [];
    let timeSlotsData = [];

    // Load data from hidden script tags
    try {
        roomsData = JSON.parse(document.getElementById('roomsData').textContent);
        seatsData = JSON.parse(document.getElementById('seatsData').textContent);
        timeSlotsData = JSON.parse(document.getElementById('timeSlotsData').textContent);
    } catch (e) {
        console.error('Error loading room/seat data:', e);
        roomsData = [];
        seatsData = [];
        timeSlotsData = [];
    }


    function loadSeatsForRoom() {
        const roomSelect = document.getElementById('rooms');
        const selectedRoomId = roomSelect.value;
        const seatsGrid = document.getElementById('seatsGrid');
        const bookButton = document.getElementById('bookButton');
        
        // Clear previous seats
        seatsGrid.innerHTML = '';
        selectedSeat = null;
        bookButton.disabled = true;
        
        if (!selectedRoomId) return;
        
        // Filter seats for selected room
        const roomSeats = seatsData.filter(seat => {
            // Handle both tuple format (database result) and object format
            const seatRoomId = seat[1] || seat.room_id; // Assuming room_id is at index 1
            return seatRoomId == selectedRoomId;
        });
        
        // Create seat buttons
        roomSeats.forEach((seat, index) => {
            const seatId = seat[0] || seat.id;
            const seatName = seat[2] || seat.name || `Seat ${index + 1}`;
            const isOccupied = seat[3] || seat.occupied || false;
            
            const seatButton = document.createElement('button');
            seatButton.className = `seat ${isOccupied ? 'occupied' : 'free'}`;
            seatButton.textContent = seatName;
            seatButton.disabled = isOccupied;
            seatButton.onclick = () => selectSeat(seatId, seatName, selectedRoomId);
            
            seatsGrid.appendChild(seatButton);
        });
        
        // If no seats found, create default grid
        if (roomSeats.length === 0) {
            for (let i = 1; i <= 20; i++) {
                const seatButton = document.createElement('button');
                seatButton.className = 'seat free';
                seatButton.textContent = `Seat ${i}`;
                seatButton.onclick = () => selectSeat(i, `Seat ${i}`, selectedRoomId);
                seatsGrid.appendChild(seatButton);
            }
        }
    }

    function selectSeat(seatId, seatName, roomId) {
        // Remove previous selection
        document.querySelectorAll('.seat.selected').forEach(seat => {
            seat.classList.remove('selected');
        });
        
        // Select new seat
        event.target.classList.add('selected');
        selectedSeat = {
            id: seatId,
            name: seatName,
            roomId: roomId
        };
        
        // Enable book button
        document.getElementById('bookButton').disabled = false;
        
        console.log(`Selected seat: ${seatName} in room ${roomId}`);
    }

    function bookSelectedSeat() {
        if (!selectedSeat) {
            alert('Bitte wÃ¤hlen Sie einen Platz aus.');
            return;
        }
        
        // Save selected occupied seat and Id
        localStorage.setItem('selectedSeat', JSON.stringify(selectedSeat));
        alert('Seat {selectedSeat.name} booked succesfully!');

    //function to secure login and encode password
    function secureLogin() {
        const userId = document.getElementById('userId').value;
        const password = document.getElementById('password').value;
        if (!userId || !password) {
            alert('Bitte geben Sie Ihre Benutzer-ID und Ihr Passwort ein.');
            return;
        }

        // Encode password with Fernet
        const fernet = new cryptography.fernet.Fernet('your-secret-key');
        const encodedPassword = fernet.encrypt(password);
        console.log(`User ID: ${userId}, Encoded Password: ${encodedPassword}`);
    }


        // fetch('/api/book-seat', {
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json'
        //     },
        //     body: JSON.stringify({
        //         seatId: selectedSeat.id,
        //         roomId: selectedSeat.roomId,
        //         seatName: selectedSeat.name
        //     })
        // })
        // .then(response => response.json())
        // .then(data => {
        //     if (data.success) {
        //         alert(`Platz ${selectedSeat.name} wurde erfolgreich gebucht!`);
        //         // Mark seat as occupied
        //         event.target.classList.remove('free', 'selected');
        //         event.target.classList.add('occupied');
        //         event.target.disabled = true;
        //         selectedSeat = null;
        //         document.getElementById('bookButton').disabled = true;
        //     } else {
        //         alert(`Fehler beim Buchen: ${data.message}`);
        //     }
        // })
        // .catch(error => {
        //     console.error('Booking error:', error);
        //     alert('Fehler beim Buchen des Platzes.');
        // });
    }

    // Add time validation
    function validateTimeSelection() {
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        
        if (startTime && endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            
            if (endMinutes <= startMinutes) {
                alert('End time must be after start time');
                document.getElementById('endTime').value = '';
                return false;
            }
        }
        return true;
    }

    function timeToMinutes(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
    }

    // Add event listeners for time validation
    document.addEventListener('DOMContentLoaded', () => {
        const startTimeSelect = document.getElementById('startTime');
        const endTimeSelect = document.getElementById('endTime');
        
        startTimeSelect.addEventListener('change', validateTimeSelection);
        endTimeSelect.addEventListener('change', validateTimeSelection);
    });
</script>