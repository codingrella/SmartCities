<!DOCTYPE html>
<html>
    <head>
        <title>Dashboard</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='Styles/Dashboard_style.css') }}">
    </head>
    <body>
        <div class="container">
            <div class="row align-items-center mb-4 mt-4">
                <div class="col-auto">
                    <h1 class="mb-0">The Think Lounge Dashboard</h1>
                </div>
                <div class="col-auto">
                    <div class="button">
                        <button onclick="startCheckIn()" class="btn btn-primary">Check In</button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="card dashboard-card-big">
                    <div class="card-header">
                        <h3>Study Room Seating Plan</h3>
                        <div class="seat-stats">
                            <span class="stat-item">
                                <span class="seat-indicator free"></span>
                                Free: <span id="freeSeats">{% if free_seats is not none %}{{ free_seats }}{% else %}0{% endif %}</span>
                            </span>
                            <span class="stat-item">
                                <span class="seat-indicator occupied"></span>
                                Occupied: <span id="occupiedSeats">{% if occupied_seats is not none %}{{ occupied_seats }}{% else %}0{% endif %}</span>
                            </span>
                            <span class="stat-item">
                                Total: <span id="totalSeats">{% if total_seats is not none %}{{ total_seats }}{% else %}0{% endif %}</span>
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="room-selection">
                            <label for="dashboardRooms">Select Room:</label>
                            <select name="room" id="dashboardRooms" onchange="loadSeatsForDashboard()">
                                <option value="firstRoomName">{{ firstRoomName }}</option>
                            </select>
                            <div class="seat-legend">
                                <div class="legend-item">
                                    <div class="seat-indicator free"></div>
                                    <span>Available</span>
                                </div>
                                <div class="legend-item">
                                    <div class="seat-indicator occupied"></div>
                                    <span>Occupied</span>
                                </div>
                            </div>
                            <div class="seating-grid" id="mainSeatingGrid">
                                <!-- Seats will be loaded here dynamically -->
                            </div>
                            <div class="booking-section">
                                <button type="button" class="btn btn-primary btn-lg" onclick="openBookingSystem()">
                                    Book Here
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card dashboard-card-small">
                    <div class="card-header">
                        <h3>Real time Environmental Data</h3>
                        <div class="sensor-data">
                            <div class="sensor-item">
                                <div class="sensor-icon">üå°Ô∏è</div>
                                <div class="sensor-info">
                                    <h4>Temperature</h4>
                                    <div class="sensor-value" id="temperature">{% if temperature is not none %}{{ temperature }}{% else %}0{% endif %}</div>
                                </div>
                            </div>
                            <div class="sensor-item">
                                <div class="sensor-icon">üíß</div>
                                <div class="sensor-info">
                                    <h4>Humidity</h4>
                                    <div class="sensor-value" id="humidity">{% if humidity is not none %}{{ humidity }}{% else %}0{% endif %}</div>
                                </div>
                            </div>
                            <div class="sensor-item">
                                <div class="sensor-icon">üîä</div>
                                <div class="sensor-info">
                                    <h4>Sound Level</h4>
                                    <div class="sensor-value" id="soundlevel">{% if soundlevel is not none %}{{ soundlevel }}{% else %}0{% endif %}</div>
                                </div>
                            </div>
                            <div class="sensor-item">
                            <div class="sensor-icon" id="lightIcon">üåë</div>
                            <div class="sensor-info">
                                <h4>Outside Light Level</h4>    
                                <div class="sensor-value">
                                    <div class="range-slider">
                                        <input type="range" min="0" max="2" value="0" class="slider" id="lightLevelSlider" oninput="updateLightLevel()">
                                        <div class="slider-ticks">
                                            <span class="tick">Dark</span>
                                            <span class="tick">Sunny</span>
                                            <span class="tick">Very Sunny</span>
                                        </div>
                                    </div>
                                    <div class="light-level-text" id="lightLevelText">Dark</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden data for JavaScript -->
        <!-- Hidden data for JavaScript -->
        <script type="application/json" id="dashboardRoomsData">{{ rooms | tojson if rooms else '[]' }}</script>
        <script type="application/json" id="dashboardSeatsData">{{ seats | tojson if seats else '[]' }}</script>
        <!-- MQTT.js library from CDN -->
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
        <script>
            // MQTT connection setup
            const mqttBrokerUrl = 'ws://192.168.188.40:9001'; // Example public broker
            const mqttOptions = {
                clientId: 'dashboard_' + Math.random().toString(16).substr(2, 8),
                clean: true,
                connectTimeout: 4000,
                reconnectPeriod: 4000,
            };

            let mqttClient = null;

            function connectMQTT() {
                mqttClient = mqtt.connect(mqttBrokerUrl, mqttOptions);

                mqttClient.on('connect', function () {
                    console.log('Connected to MQTT broker');

                    mqttClient.subscribe('library/SR_1/Sensor/#', function (err) {
                        if (!err) {
                            console.log('Subscribed to library/SR_1/Sensor');
                            // publish on new input of outside lightlevel slider
                            document.getElementById('lightLevelSlider').addEventListener('input', function () {
                                const lightlevel = this.value;
                                mqttClient.publish('library/SR_1/Sensor/Outside_Light',
                                    `{'Device': 'Outside_Light', 'Value': '${lightlevel}', 'TimeStamp': '${new Date().toLocaleTimeString()}'}`,
                                    { qos: 1, retain: true });
                            });
                        } else if (err.message === 'Invalid topic') {
                            console.error('Invalid topic for subscription:', err);
                        } else {
                            console.error('Subscription error:', err);
                        }
                    });
                    
                });

                mqttClient.on('error', function (err) {
                    console.error('MQTT connection error:', err);
                });

                mqttClient.on('reconnect', function () {
                    console.log('Reconnecting to MQTT broker...');
                });

                mqttClient.on('message', function (topic, message) {
                // message is Buffer
                    console.log(message.toString())
                    const datafrommessage = message.toString();
                    console.log('Received message:', datafrommessage);
                    //Replace the ' with " in the message
                    message = datafrommessage.replace(/'/g, '"');
                    console.log('Parsed message:', message);
                    try {
                        const data = JSON.parse(message.toString());
                        // console.log('Received message:', data);

                        // Update sensor values in the dashboard
                        if (data.Device === 'Temperature_Sensor') {
                            document.getElementById('temperature').textContent = data.Value + '¬∞C';
                        } else if (data.Device === 'Humidity_Sensor') {
                            document.getElementById('humidity').textContent = data.Value + '%';
                        } else if (data.Device === 'Sound_Sensor') {
                            document.getElementById('soundlevel').textContent = data.Value;
                        } else if (data.Device === 'Light_Sensor') {
                            document.getElementById('lighting').value = data.Value;
                            updateLightLevel();
                        }
                    } catch (e) {
                        console.error('Error parsing MQTT message:', e);
                    }
                });
                // try{
                //     const data = JSON.parse(message);
                //     console.log('Received message:', data);

                //     // Update sensor values in the dashboard
                //     if (data.Device === 'Temperature_Sensor') {
                //         document.getElementById('temperature').textContent = data.Value + '¬∞C';
                //     } if (data.Device === 'Humidity_Sensor') {
                //         document.getElementById('humidity').textContent = data.Value + '%';
                //     } if (data.Device === 'Sound_Sensor') {
                //         document.getElementById('soundlevel').textContent = data.Value;
                //     } if (data.Device === 'Light_Sensor') {
                //         document.getElementById('lighting').value = data.Value;
                //         updateLightLevel();
                //     }
                // } catch (e) {
                //     console.error('Error parsing MQTT message:', e);
                // }
            // }
        }
            // Call connectMQTT on page load
            connectMQTT();
        </script>
    </body>
</html>

<script>
    let seatingData = [];
    let roomsData = [];
    let seatsData = [];
    let currentRoom = 'SR1'; // Default room
    
    // Load data from hidden script tags
    try {
        //parse the array of rooms and seats from the hidden script tags
        roomsData = JSON.parse(document.getElementById('dashboardRoomsData').textContent);
        console.log(roomsData);
        // get room name from the first room in the array
        const firstRoomName = roomsData[0];
        console.log(firstRoomName); // Outputs the name of the first room
        seatsData = JSON.parse(document.getElementById('dashboardSeatsData').textContent);
        console.log(seatsData);
    } catch (e) {
        console.error('Error loading room/seat data:', e);
        roomsData = [];
        seatsData = [];
    }
    
    function openBookingSystem() {
        // Function to open the booking system pop up with time selection
        const bookingWindow = window.open(
            '/dashboard/booking',
            'Booking System',
            'width=900, height=600, scrollbars=yes'
        );
        if (bookingWindow) {
            bookingWindow.focus();
        } else {
            alert('Please allow pop-ups for this website to open the booking system.');
        }
    }

    function loadSeatsForDashboard() {
        const roomSelect = document.getElementById('dashboardRooms');
        console.log('Selected room:', roomSelect.value);
        const selectedRoomId = roomSelect.value;
        const seatsGrid = document.getElementById('mainSeatingGrid');
        
        // Clear previous seats
        seatsGrid.innerHTML = '';
        
        if (!selectedRoomId) return;
        
        // Filter seats for selected room (if we have dynamic data)
        let roomSeats = seatsData.filter(seat => {
            const seatRoomId = seat[1] || seat.room_id;
            return seatRoomId == selectedRoomId;
        });
        
        // If no dynamic data, create sample seats
        // if (roomSeats.length === 0) {
        //     roomSeats = [];
        //     for (let i = 1; i <= 20; i++) {
        //         roomSeats.push({
        //             id: i,
        //             name: `Seat ${i}`,
        //             occupied: Math.random() > 0.7, // 30% chance of being occupied
        //             room: selectedRoomId
        //         });
        //     }
        // }
        
        // Create seat buttons (view-only)
        roomSeats.forEach((seat, index) => {
            const seatId = seat.id || seat[0];
            const seatName = seat.name || seat[2] || `Seat ${index + 1}`;
            const isOccupied = seat.occupied || seat[3] || false;
            
            const seatButton = document.createElement('div');
            seatButton.className = `seat ${isOccupied ? 'occupied' : 'free'}`;
            seatButton.textContent = seatName;
            seatButton.title = `${seatName} - ${isOccupied ? 'Occupied' : 'Available'}`;
            
            seatsGrid.appendChild(seatButton);
        });
        
        // Update seat statistics
        updateSeatStats(roomSeats);
    }

    // Load seating plan data
    function loadSeatingPlan() {
        fetch('/api/seating-plan')
            .then(response => response.json())
            .then(data => {
                seatsData = data.seats || [];
                roomsData = data.rooms || [];
                loadSeatsForDashboard();
            })
            .catch(error => {
                console.error('Error loading seating plan:', error);
                // Load sample seating plan
                loadSeatsForDashboard();
            });
    }

    function updateSeatStats(seats) {
        const totalSeats = seats.length;
        //get occupied seats by selecting all true values from seats
        const occupiedSeats = seats.filter(seat => seat.occupied || seat[3]).length;
        const freeSeats = totalSeats - occupiedSeats;
        
        document.getElementById('totalSeats').textContent = totalSeats;
        document.getElementById('occupiedSeats').textContent = occupiedSeats;
        document.getElementById('freeSeats').textContent = freeSeats;
    }

    // Load real-time sensor data
    function loadSensorData() {
        //load sensor data from message broker

        // fetch('/api/data')
        //     .then(response => response.json())
        //     .then(data => {
        //         document.getElementById('humidity').textContent = data.humidity + '%';
        //         document.getElementById('temperature').textContent = data.temperature + '¬∞C';
        //         document.getElementById('airQuality').textContent = data.light + ' lux';
        //     })
        //     .catch(error => {
        //         console.error('Error loading sensor data:', error);
        //         document.getElementById('humidity').textContent = 'N/A';
        //         document.getElementById('temperature').textContent = 'N/A';
        //         document.getElementById('airQuality').textContent = 'N/A';
        //     });
    }

    function updateLightLevel() {
    const slider = document.getElementById('lightLevelSlider');
    const icon = document.getElementById('lightIcon');
    const text = document.getElementById('lightLevelText');
    const value = parseInt(slider.value);
    
    // Update icon and text based on slider value
    switch(value) {
        case 0:
            icon.textContent = 'üåë';
            text.textContent = 'Dark';
            break;
        case 1:
            icon.textContent = 'üå§Ô∏è';
            text.textContent = 'Sunny';
            break;
        case 2:
            icon.textContent = '‚òÄÔ∏è';
            text.textContent = 'Very Sunny';
            break;
    }
    
    console.log('Light level changed to:', text.textContent);

    // Optional: Send to server
    updateLightLevelOnServer(value);
}

function updateLightLevelOnServer(level) {
    fetch('/api/light-level', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ level: level })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Light level updated on server:', data);
    })
    .catch(error => {
        console.error('Error updating light level:', error);
    });
}

function initializeLightLevel() {
    const slider = document.getElementById('lightLevelSlider');
    slider.value = 0; // Default to dark
    updateLightLevel();
}

    // Initialize dashboard
    window.addEventListener('load', function() {
        initializeLightLevel();
        loadSeatingPlan();
        loadSensorData();
    });
    
    // Refresh data periodically
    setInterval(loadSensorData, 30000); // Every 30 seconds
    setInterval(loadSeatingPlan, 60000); // Every minute

    function startCheckIn() {
        // Check In function
        //change the button color and text
        const button = document.querySelector('.button button');
        button.style.backgroundColor = '#28a745'; // Green color
        button.textContent = 'Checked In';
    
        //check out --> change the button back to original color and text
        button.onclick = function() {
            button.style.backgroundColor = '#007bff'; // Original color
            button.textContent = 'Check In';
        }

        //time stamp for check-in
        const timestamp = new Date().toLocaleTimeString();
        console.log('Checked in at:', timestamp);

        //send data to db and change start time to stamped time
    }
</script>